Bootstrap: docker
From: dxkb/boltz-bvbrc:latest-gpu

%labels
    Author BV-BRC Team
    Application Boltz
    Version 2.2.1
    Description Boltz biomolecular structure prediction with BV-BRC AppService integration
    BaseImage dxkb/dev_container:cuda12-ubuntu22.04

%help
    Boltz BV-BRC Service Container
    ==============================

    This container provides Boltz-2 biomolecular structure prediction
    integrated with the BV-BRC AppService framework.

    Features:
    - Boltz-2 structure prediction (proteins, DNA, RNA, ligands)
    - Binding affinity prediction
    - MSA server integration
    - BV-BRC workspace integration

    Usage Examples:

    # Run Boltz directly
    singularity run --nv container.sif boltz predict input.yaml --use_msa_server

    # Run as BV-BRC service
    singularity run --nv container.sif App-Boltz params.json

    # Interactive shell
    singularity shell --nv container.sif

    Environment:
    - GPU required for reasonable performance
    - Model weights cached in /root/.boltz (bind mount for persistence)
    - Workspace files in /data
    - Uses standardized BV-BRC paths (/opt/patric-common/)

%environment
    # Standard BV-BRC Environment (from dxkb/dev_container)
    export RT=/opt/patric-common/runtime
    export KB_DEPLOYMENT=/opt/patric-common/deployment
    export KB_TOP=/opt/patric-common/deployment
    export PERL5LIB=$KB_DEPLOYMENT/lib:$RT/lib/perl5
    export PATH=$KB_DEPLOYMENT/bin:$RT/bin:/kb/module/scripts:$PATH

    # App-specific environment
    export KB_MODULE_DIR=/kb/module
    export IN_BVBRC_CONTAINER=1
    export BOLTZ_CACHE=/root/.boltz

%runscript
    case "$1" in
        App-Boltz*)
            shift
            exec $RT/bin/perl /kb/module/service-scripts/App-Boltz.pl "$@"
            ;;
        boltz)
            shift
            exec boltz "$@"
            ;;
        bash|sh)
            exec /bin/bash
            ;;
        *)
            if [ -z "$1" ]; then
                echo "Boltz BV-BRC Container"
                echo "Usage: singularity run --nv container.sif [command]"
                echo ""
                echo "Commands:"
                echo "  boltz predict <input> [options]  - Run structure prediction"
                echo "  App-Boltz <params.json>          - Run as BV-BRC service"
                echo "  bash                             - Interactive shell"
                echo ""
                echo "For help: singularity run --nv container.sif boltz --help"
            else
                exec "$@"
            fi
            ;;
    esac

%test
    echo "Testing Boltz BV-BRC container..."

    # Test Python/Boltz
    echo -n "Python: "
    python3 --version

    echo -n "Boltz: "
    boltz --version 2>&1 | head -1 || echo "boltz command available"

    # Test Perl/BV-BRC (using standard path)
    echo -n "Perl: "
    /opt/patric-common/runtime/bin/perl -v | grep version | head -1

    echo -n "Perl version check: "
    /opt/patric-common/runtime/bin/perl -v | grep -q "v5.40" && echo "5.40.x OK" || echo "WARN: expected 5.40.x"

    echo -n "BV-BRC modules: "
    /opt/patric-common/runtime/bin/perl -e 'use Bio::KBase::AppService::AppScript; print "OK\n"' 2>/dev/null || echo "WARN: AppScript not fully available (expected in test)"

    # Test standard BV-BRC paths
    echo -n "BV-BRC runtime: "
    test -d /opt/patric-common/runtime && echo "OK" || echo "MISSING"

    echo -n "BV-BRC deployment: "
    test -d /opt/patric-common/deployment && echo "OK" || echo "MISSING"

    echo -n "p3 CLI tools: "
    test -f /opt/patric-common/deployment/bin/p3-login && echo "OK" || echo "MISSING"

    # Test service script exists
    echo -n "Service script: "
    test -f /kb/module/service-scripts/App-Boltz.pl && echo "OK" || echo "MISSING"

    # Test app specs
    echo -n "App specs: "
    test -f /kb/module/app_specs/Boltz.json && echo "OK" || echo "MISSING"

    echo "Container tests completed"

%post
    echo "Boltz BV-BRC container build complete"

    # Verify key components
    which boltz || echo "Warning: boltz not in PATH"
    test -f /opt/patric-common/runtime/bin/perl && echo "BV-BRC Perl: OK" || echo "Warning: BV-BRC Perl not found"

    # List BV-BRC deployment
    echo "BV-BRC deployment contents:"
    ls -la /opt/patric-common/deployment/bin/ 2>/dev/null | head -10 || echo "No deployment bin directory"

    echo "BV-BRC lib contents:"
    ls /opt/patric-common/deployment/lib/ 2>/dev/null | head -10 || echo "No deployment lib directory"

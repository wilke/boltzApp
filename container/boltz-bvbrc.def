Bootstrap: docker
From: dxkb/boltz-bvbrc:latest-gpu

%labels
    Author BV-BRC Team
    Application Boltz
    Version 2.2.1
    Description Boltz biomolecular structure prediction with BV-BRC AppService integration

%help
    Boltz BV-BRC Service Container
    ==============================

    This container provides Boltz-2 biomolecular structure prediction
    integrated with the BV-BRC AppService framework.

    Features:
    - Boltz-2 structure prediction (proteins, DNA, RNA, ligands)
    - Binding affinity prediction
    - MSA server integration
    - BV-BRC workspace integration

    Usage Examples:

    # Run Boltz directly
    singularity run --nv container.sif boltz predict input.yaml --use_msa_server

    # Run as BV-BRC service
    singularity run --nv container.sif App-Boltz params.json

    # Interactive shell
    singularity shell --nv container.sif

    Environment:
    - GPU required for reasonable performance
    - Model weights cached in /root/.boltz (bind mount for persistence)
    - Workspace files in /data

%environment
    export PERL5LIB=/bvbrc/modules/app_service/lib:/bvbrc/modules/Workspace/lib:/bvbrc/modules/p3_core/lib:/bvbrc/modules/p3_auth/lib:/bvbrc/modules/seed_core/lib:/bvbrc/modules/seed_gjo/lib:/kb/module/lib
    export KB_TOP=/kb/deployment
    export KB_RUNTIME=/usr
    export KB_MODULE_DIR=/kb/module
    export IN_BVBRC_CONTAINER=1
    export BOLTZ_CACHE=/root/.boltz
    export PATH=/kb/module/scripts:$PATH

%runscript
    case "$1" in
        App-Boltz*)
            shift
            exec perl /kb/module/service-scripts/App-Boltz.pl "$@"
            ;;
        boltz)
            shift
            exec boltz "$@"
            ;;
        bash|sh)
            exec /bin/bash
            ;;
        *)
            if [ -z "$1" ]; then
                echo "Boltz BV-BRC Container"
                echo "Usage: singularity run --nv container.sif [command]"
                echo ""
                echo "Commands:"
                echo "  boltz predict <input> [options]  - Run structure prediction"
                echo "  App-Boltz <params.json>          - Run as BV-BRC service"
                echo "  bash                             - Interactive shell"
                echo ""
                echo "For help: singularity run --nv container.sif boltz --help"
            else
                exec "$@"
            fi
            ;;
    esac

%test
    echo "Testing Boltz BV-BRC container..."

    # Test Python/Boltz
    echo -n "Python: "
    python3 --version

    echo -n "Boltz: "
    boltz --version 2>&1 | head -1 || echo "boltz command available"

    # Test Perl/BV-BRC
    echo -n "Perl: "
    perl -v | grep version | head -1

    echo -n "BV-BRC modules: "
    perl -e 'use Bio::KBase::AppService::AppScript; print "OK\n"' 2>/dev/null || echo "WARN: AppScript not fully available (expected in test)"

    # Test service script exists
    echo -n "Service script: "
    test -f /kb/module/service-scripts/App-Boltz.pl && echo "OK" || echo "MISSING"

    # Test app specs
    echo -n "App specs: "
    test -f /kb/module/app_specs/Boltz.json && echo "OK" || echo "MISSING"

    echo "Container tests completed"

%post
    echo "Boltz BV-BRC container build complete"

    # Verify key components
    which boltz || echo "Warning: boltz not in PATH"
    which perl || echo "Warning: perl not in PATH"

    # List installed BV-BRC modules
    echo "BV-BRC modules installed:"
    ls -la /bvbrc/modules/ 2>/dev/null || echo "No modules directory"
